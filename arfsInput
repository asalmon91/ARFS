function [ packet ] = arfsInput( )
%Main I/O for ARFS
%   Detailed explanation goes here

warning off; %#ok<WNOFF>

packet = [];

prompt = {
    'Enter path',...
    'Enter video name (avi''s only please) or leave blank to process whole directory',...
    'Enter output file name, if left blank it will be named after the path',...
    'Primary modality: (leave blank to process all)',...
    'Type on or off to toggle display',...
    'Strip size for distortion detection',...
    'Number of frames to output'...
    'Skip Motion Tracking?'
    };
dlg_title = 'ARFS 2015';
num_lines = 1;
defaults  = {'','','','all','off','20','10','no'};

if ispc
    slash = '\';
else
    slash = '/';
end

%% INPUT VALIDATION LOOP
inputInvalid = true;
while inputInvalid
    inputInvalid = false;
    
    response = inputdlg(prompt, dlg_title, num_lines, defaults);
    defaults = response;
    
    if isempty(response)
        fprintf('\nThat''s okay, maybe later.\n\n');
        return;
    end

    %% PATH CONTROL
    path = response{1};
    if exist(path,'dir') == 7
        addpath(path);
        defaults{1} = path;
    else
        beep;
        msg = 'Path not found';
        h = msgbox(msg,'Error','replace');
        inputInvalid = true;
        continue;
    end

    %% OUTPUT CONTROL
    outputCSV = response{3};
    if isempty(outputCSV)
        pathParts = strsplit(path,slash);
        outputCSV = strcat(pathParts{2},'_',pathParts{end-1});
        defaults{3} = outputCSV;
        outputFile = strcat(path,slash,outputCSV,'.xlsx');
    else
        try
            % writing a test file
            a = magic(3);
            T = table(a);
            outputFile = strcat(path,slash,outputCSV,'.xlsx');
            sheetName = 'test';
            writetable(T, outputFile, 'Sheet', sheetName);
            defaults{3} = outputCSV;
        catch
            % report error
            beep;
            msg = 'Output file name invalid';
            h = msgbox(msg,'Error','replace');
            inputInvalid = true;
            continue;
        end
    end

    %% PRIMARY SEQUENCE CONTROL
    primInd = 4;
    prim = response{primInd};
    acceptMod = {'CONFOCAL', 'DIRECT', 'REFLECT', 'AVG', 'SPLIT',...
        'SPLIT_DET', 'SPLIT DETECTOR', 'ALL'};
    splits = {'SPLIT', 'SPLIT_DET', 'SPLIT DETECTOR'};
    if isempty(prim)
        mod = 'ALL';
        defaults{primInd} = mod;
    elseif any(strcmpi(prim,acceptMod))
        if any(strcmpi(prim,splits))
            mod = 'SPLIT';
        else
            mod = prim;
        end
        defaults{primInd} = prim;
    else
        beep;
        msg = ['When did we start acquiring "',prim,'" sequences?'];
        h = msgbox(msg,'Error','replace');
        inputInvalid = true;
        continue;
    end
    
    %% FILE NAME(S) CONTROL
    name = response{2};
    if isempty(name)
        single = false;
        if strcmpi(mod,'ALL')
            pathAvi = horzcat(path,slash,'*.avi');
            videoFiles = dir(pathAvi);
        else
            checkMod = ['*',lower(mod),'*'];
            pathAvi  = horzcat(path,slash,checkMod);
            checkExt = dir(pathAvi);
            if isempty(checkExt)
                beep;
                msg = ['Couldn''t find any ',lower(mod),' videos'];
                msgbox(msg,'Error','replace');
                inputInvalid = true;
                continue;
            else
                j=0;
                for i=1:length(checkExt)
                    parts = strsplit(checkExt(i).name,'.');
                    if strcmp(parts{end},'avi')
                        j = j+1;
                        videoFiles(j) = checkExt(i); 
                    end
                end
                if isempty(videoFiles)
                    beep;
                    msg = ['Couldn''t find any ',lower(mod),' videos'];
                    msgbox(msg,'Error','replace');
                    inputInvalid = true;
                    continue;
                end
                clear checkExt;
            end
        end
        nFiles = numel(videoFiles);
    else
        single = true;
        avi = 'avi';
        nameParts = strsplit(name,'.');
        suffix = nameParts{end};
        if not(strcmp(avi,suffix))
            name = strcat(name,avi);
        end
        if exist(name,'file') == 2
            videoFiles.name = name;
            single = true;
            nFiles = 1;
            defaults{2} = name;
        else
            beep;
            msg = 'File not found or file invalid';
            h = msgbox(msg,'Error','replace');
            inputInvalid = true;
            continue;
        end
    end    
    %% DISPLAY CONTROL
    
    dis = response{5};
    acceptPOS = {'ON','TRUE','Y','YES','YEP','YUP','SURE'};
    acceptNEG = {'OFF','FALSE','N','NO','NOPE'};
    if isempty(dis)
        display = false;
    elseif any(strcmpi(dis,acceptPOS))
        display = true;
        defaults{4} = dis;
    elseif any(strcmpi(dis,acceptNEG))
        display = false;
        defaults{4} = dis;
    else
        beep;
        msg = 'Sorry, did you want display on or off?';
        h = msgbox(msg,'Error','replace');
        inputInvalid = true;
        continue;
    end

    %% STRIP SIZE CONTROL
    ss = response{6};
    if isempty(ss)
        beep;
        msg = 'So, we need a strip size. It''s just for the bean counters.';
        h = msgbox(msg,'Error','replace');
        inputInvalid = true;
        continue;
    else
        ifmSS = round(str2double(ss));
        ss=ifmSS;
        if ifmSS <= 0
            msg = 'ifm strip size must be greater than 0';
        elseif isnan(ifmSS)
            msg = 'strip size should be, like, a NUMBER...';
        end
        if ifmSS <= 0 || isnan(ifmSS)
            beep;
            h = msgbox(msg,'Error','replace');
            inputInvalid = true;
            continue;
        end
    end
    
    %% FRAME REQUEST CONTROL
    frequest = response{7};
    if isempty(frequest)
        beep;
        msg = 'You can''t leave the number of frames blank; that''s anarchy';
        h = msgbox(msg,'Error','replace');
        inputInvalid = true;
        continue;
    else
        nFramesReq = round(str2double(frequest));
        if nFramesReq == 0
            beep;
            msg = 'You want no frames? Why are you even here?';
            h = msgbox(msg,'Error','replace');
            inputInvalid = true;
            continue;
        elseif nFramesReq < 0
            beep;
            msg = 'NEGATIVE FRAMES? WHAT UNIVERSE IS THIS??';
            h = msgbox(msg,'Error','replace');
            inputInvalid = true;
            continue;
        elseif not(isnumeric(nFramesReq))
            if strcmpi(frequest,'ALL')
                nFramesReq = 0;
            else
                beep;
                msg = 'What are you doing? Number of frames should be a NUMBER!';
                h = msgbox(msg,'Error','replace');
                inputInvalid = true;
                continue;
            end
        end
        if nFramesReq > 0 && nFramesReq < 3
            fprintf('\nJust a heads up, I would request at least 3 frames\n');
        end
    end
    
    %% MOTION TRACKING SKIP CONTROL
    mtsind = 8;
    mtskip = response{mtsind};
    if isempty(mtskip)
        beep;
        msg = 'Oops! But about motion tracking... Do it? Don''t do it?';
        h = msgbox(msg,'Error','replace');
        inputInvalid = true;
        continue;
    elseif any(strcmpi(mtskip,acceptPOS))
        mtskip = true;
        defaults{mtsind} = 'yes';
    elseif any(strcmpi(mtskip,acceptNEG))
        mtskip = false;
        defaults{mtsind} = 'no';
    else
        beep;
        msg = 'FATAL ERROR!!! Just kidding, MORBID error: skip motion tracking?';
        h = msgbox(msg,'Error','replace');
        inputInvalid = true;
        continue;
    end
    
end


%% Setup output packet
packet.vid     = videoFiles;
packet.slash   = slash;
packet.single  = single;
packet.nFiles  = nFiles;
packet.mod     = mod;
packet.ss      = ss;
packet.nReq    = nFramesReq;
packet.display = display;
packet.outFile = outputFile;
packet.path    = path;
packet.mtskip  = mtskip;

end

